#
# {{ ansible_managed }}
#

## Remove any existing rules
-D

## Increase buffer size to handle the increased number of messages.
## Feel free to increase this if the machine panic's
-b {{ security_auditd_buffer_size }}

## Set failure mode to panic
-f {{ security_auditd_failure_mode }}

-a always,exit -F arch=b32 -S adjtimex -S settimeofday -S stime -F uid!=ntp -F auid!=4294967295 -k time-change
-a always,exit -F arch=b64 -S adjtimex -S settimeofday -F uid!=ntp -F auid!=4294967295 -k time-change
-a always,exit -F arch=b32 -S clock_settime -F a0=0 -k time-change
-a always,exit -F arch=b64 -S clock_settime -F a0=0 -k time-change
-w /etc/localtime -p wa -k time-change
-a always,exit -F arch=b32 -S sethostname -S setdomainname -k system-locale
-a always,exit -F arch=b64 -S sethostname -S setdomainname -k system-locale
-w /etc/issue -p wa -k system-locale
-w /etc/issue.net -p wa -k system-locale
-w /etc/hosts -p wa -k system-locale
-w /etc/sysconfig/network -p wa -k system-locale
-a always,exit -F arch=b32 -S creat -S mkdir -S mknod -S link -S symlink -S mknodat -S linkat -S symlinkat -F exit=-EACCES -k creation
-a always,exit -F arch=b64 -S creat -S mkdir -S mknod -S link -S symlink -S mknodat -S linkat -S symlinkat -F exit=-EACCES -k creation
-a always,exit -F arch=b32 -S creat -S mkdir -S mknod -S link -S symlink -S mknodat -S linkat -S symlinkat -F exit=-EPERM -k creation
-a always,exit -F arch=b64 -S creat -S mkdir -S mknod -S link -S symlink -S mknodat -S linkat -S symlinkat -F exit=-EPERM -k creation
-a always,exit -F arch=b32 -S mkdir -S mkdirat -S link -S symlink -F exit=-EPERM -k creation
-a always,exit -F arch=b64 -S mkdir -S mkdirat -S link -S symlink -F exit=-EPERM -k creation
-a always,exit -F arch=b32 -S open -S openat -S open_by_handle_at -F exit=-EACCES -k open
-a always,exit -F arch=b64 -S open -S openat -S open_by_handle_at -F exit=-EACCES -k open
-a always,exit -F arch=b32 -S open -S openat -S open_by_handle_at -F exit=-EPERM -k open
-a always,exit -F arch=b64 -S open -S openat -S open_by_handle_at -F exit=-EPERM -k open
-a always,exit -F arch=b32 -S close -F exit=-EIO -k close
-a always,exit -F arch=b64 -S close -F exit=-EIO -k close
-a always,exit -F arch=b32 -S rename -S renameat -S truncate -S ftruncate -F exit=-EACCES -k mods
-a always,exit -F arch=b64 -S rename -S renameat -S truncate -S ftruncate -F exit=-EACCES -k mods
-a always,exit -F arch=b32 -S rename -S renameat -S truncate -S ftruncate -S chmod -S setxattr -S lsetxattr -S removexattr -S lremovexattr -F exit=-EPERM -k mods
-a always,exit -F arch=b64 -S rename -S renameat -S truncate -S ftruncate -S chmod -S setxattr -S lsetxattr -S removexattr -S lremovexattr -F exit=-EPERM -k mods
-a always,exit -F arch=b32 -S chmod -S setxattr -S lsetxattr -S removexattr -S lremovexattr -S chown -S lchown -S fchmod -S fchmodat -S fchown -S fchownat -S fremovexattr -S fsetxattr -F auid>=500 -F auid!=4294967295 -k perm_mod
-a always,exit -F arch=b64 -S chmod -S setxattr -S lsetxattr -S removexattr -S lremovexattr -S chown -S lchown -S fchmod -S fchmodat -S fchown -S fchownat -S fremovexattr -S fsetxattr -F auid>=500 -F auid!=4294967295 -k perm_mod
-a always,exit -F arch=b32 -S rmdir -S unlink -S unlinkat -k delete
-a always,exit -F arch=b64 -S rmdir -S unlink -S unlinkat -k delete
-w /etc/group -p wa -k auth
-w /etc/passwd -p wa -k auth
-w /etc/gshadow -p wa -k auth
-w /etc/shadow -p wa -k auth
-w /etc/security/opasswd -p wa -k auth
-w /sbin/insmod -p x -k modules
-w /sbin/rmmod -p x -k modules
-w /sbin/modprobe -p x -k modules
-a always,exit -F arch=b32 -S init_module -S delete_module -k modules
-a always,exit -F arch=b64 -S init_module -S delete_module -k modules
-a always,exit -F arch=b32 -S mount -F auid>=500 -F auid!=4294967295 -k export
-a always,exit -F arch=b64 -S mount -F auid>=500 -F auid!=4294967295 -k export
# Watch for any creations, modifications or deletions when this criteria is met:
# - Non-system account (uid is greater than or equal to 500)
# - Not anonymous (make sure audit=1 is in grub configuration to limit this from happening)
# - Effective euid is a system account (uid is less than 500)
-a always,exit -F arch=b32 -S creat -S mkdir -S mknod -S link -S symlink -S mknodat -S linkat -S symlinkat -S rename -S renameat -S truncate -S ftruncate -S fallocate -S mkdirat -S chmod -S setxattr -S lsetxattr -S removexattr -S lremovexattr -S rmdir -S unlink -S unlinkat -F auid>=500 -F auid!=4294967295 -F euid<500 -k sudo_activity
-a always,exit -F arch=b64 -S creat -S mkdir -S mknod -S link -S symlink -S mknodat -S linkat -S symlinkat -S rename -S renameat -S truncate -S ftruncate -S fallocate -S mkdirat -S chmod -S setxattr -S lsetxattr -S removexattr -S lremovexattr -S rmdir -S unlink -S unlinkat -F auid>=500 -F auid!=4294967295 -F euid<500 -k sudo_activity
-w /etc/httpd/conf/httpd.conf -p wa -k httpd
-w /etc/httpd/conf.d/ssl.conf -p wa -k httpd
-w /var/ossec/etc/ossec.conf -p wa -k ossec
-w /var/ossec/etc/shared/agent.conf -p wa -k ossec
-w /etc/init.d/ossec -p wa -k ossec
-w /etc/selinux/ -p wa -k MAC-policy
-w /sbin/service -p x -k service
-w /sbin/chkconfig -p x -k service
-w /bin/systemctl -p x -k service
-w /usr/bin/reboot -p x -k uptime
-w /usr/bin/halt -p x -k uptime
-w /sbin/restart -p x -k uptime
-w /sbin/shutdown -p x -k uptime
-w /bin/rpm -p x -k package
-w /usr/bin/yum -p x -k package
-w /usr/bin/last -p x -k reco
-w /usr/bin/w -p x -k reco
-w /usr/bin/lastlog -p x -k reco
-w /bin/dmesg -p x -k reco
-w /bin/df -p x -k reco
-w /bin/hostname -p x -k reco
-w /sbin/route -p x -k reco
-w /etc/cron.allow -p wa -k cron
-w /etc/cron.deny -p wa -k cron
-w /etc/cron.d/ -p wa -k cron
-w /etc/cron.daily/ -p wa -k cron
-w /etc/cron.hourly/ -p wa -k cron
-w /etc/cron.monthly/ -p wa -k cron
-w /etc/cron.weekly/ -p wa -k cron
-w /etc/crontab -p wa -k cron
-w /var/spool/cron/root -k cron
-w /etc/login.defs -p wa -k auth
-w /etc/securetty -p wa -k auth
-w /var/run/faillock/ -p wa -k auth
-w /var/log/lastlog -p wa -k auth
-w /var/run/utmp -p wa -k session
-w /var/run/wtmp -p wa -k session
-w /var/run/btmp -p wa -k session
-w /etc/pam.d/ -p wa -k pam
-w /etc/security/access.conf -p wa -k pam
-w /etc/security/limits.conf -p wa -k pam
-w /etc/security/pam_env.conf -p wa -k pam
-w /etc/security/namespace.conf -p wa -k pam
-w /etc/security/namespace.d/ -p wa -k pam
-w /etc/security/namespace.init -p wa -k pam
-w /etc/security/sepermit.conf -p wa -k pam
-w /etc/security/time.conf -p wa -k pam
-w /etc/sudoers -p wa -k sudoers
-w /etc/sudoers.d/ -p wa -k sudoers
-w /etc/sysconfig/iptables -p wa -k iptables
-w /sbin/iptables -p x -k iptables
-w /etc/hosts -p wa -k network
-w /etc/sysconfig/network-scripts/ -p wa -k network
-w /etc/sysconfig/init -p wa -k init
-w /etc/init/ -p wa -k init
-w /etc/inittab -p wa -k init
-w /etc/rc.d/init.d/ -p wa -k init
-w /etc/sysctl.conf -p wa -k kernel
-w /etc/ssh/sshd_config -p wa -k sshd
-w /var/log/audit/ -p rwa -k auditd
-w /etc/audit/ -p wa -k auditd
-w /var/ossec/etc/ossec.conf -p wa -k ossec
-w /sbin/ -p x -k sbin
-a always,exit -F path=/usr/libexec/polkit-1/polkit-agent-helper-1 -F perm=x -F auid>=500 -F auid!=4294967295 -k privileged
-a always,exit -F path=/usr/libexec/pt_chown -F perm=x -F auid>=500 -F auid!=4294967295 -k privileged
-a always,exit -F path=/usr/libexec/openssh/ssh-keysign -F perm=x -F auid>=500 -F auid!=4294967295 -k privileged
-a always,exit -F path=/usr/libexec/abrt-action-install-debuginfo-to-abrt-cache -F perm=x -F auid>=500 -F auid!=4294967295 -k privileged
-a always,exit -F path=/usr/libexec/utempter/utempter -F perm=x -F auid>=500 -F auid!=4294967295 -k privileged
-a always,exit -F path=/usr/sbin/postqueue -F perm=x -F auid>=500 -F auid!=4294967295 -k privileged
-a always,exit -F path=/usr/sbin/postdrop -F perm=x -F auid>=500 -F auid!=4294967295 -k privileged
-a always,exit -F path=/usr/sbin/usernetctl -F perm=x -F auid>=500 -F auid!=4294967295 -k privileged
-a always,exit -F path=/usr/sbin/userhelper -F perm=x -F auid>=500 -F auid!=4294967295 -k privileged
-a always,exit -F path=/usr/bin/chsh -F perm=x -F auid>=500 -F auid!=4294967295 -k privileged
-a always,exit -F path=/usr/bin/chage -F perm=x -F auid>=500 -F auid!=4294967295 -k privileged
-a always,exit -F path=/usr/bin/passwd -F perm=x -F auid>=500 -F auid!=4294967295 -k privileged
-a always,exit -F path=/usr/bin/locate -F perm=x -F auid>=500 -F auid!=4294967295 -k privileged
-a always,exit -F path=/usr/bin/write -F perm=x -F auid>=500 -F auid!=4294967295 -k privileged
-a always,exit -F path=/usr/bin/wall -F perm=x -F auid>=500 -F auid!=4294967295 -k privileged
-a always,exit -F path=/usr/bin/crontab -F perm=x -F auid>=500 -F auid!=4294967295 -k privileged
-a always,exit -F path=/usr/bin/ksu -F perm=x -F auid>=500 -F auid!=4294967295 -k privileged
-a always,exit -F path=/usr/bin/pkexec -F perm=x -F auid>=500 -F auid!=4294967295 -k privileged
-a always,exit -F path=/usr/bin/sudo -F perm=x -F auid>=500 -F auid!=4294967295 -k privileged
-a always,exit -F path=/usr/bin/chfn -F perm=x -F auid>=500 -F auid!=4294967295 -k privileged
-a always,exit -F path=/usr/bin/staprun -F perm=x -F auid>=500 -F auid!=4294967295 -k privileged
-a always,exit -F path=/usr/bin/newgrp -F perm=x -F auid>=500 -F auid!=4294967295 -k privileged
-a always,exit -F path=/usr/bin/gpasswd -F perm=x -F auid>=500 -F auid!=4294967295 -k privileged
-a always,exit -F path=/usr/bin/at -F perm=x -F auid>=500 -F auid!=4294967295 -k privileged
-a always,exit -F path=/usr/bin/ssh-agent -F perm=x -F auid>=500 -F auid!=4294967295 -k privileged
-a always,exit -F path=/bin/cgclassify -F perm=x -F auid>=500 -F auid!=4294967295 -k privileged
-a always,exit -F path=/usr/bin/cgclassify -F perm=x -F auid>=500 -F auid!=4294967295 -k privileged
-a always,exit -F path=/bin/mount -F perm=x -F auid>=500 -F auid!=4294967295 -k privileged
-a always,exit -F path=/usr/bin/mount -F perm=x -F auid>=500 -F auid!=4294967295 -k privileged
-a always,exit -F path=/bin/su -F perm=x -F auid>=500 -F auid!=4294967295 -k privileged
-a always,exit -F path=/usr/bin/su -F perm=x -F auid>=500 -F auid!=4294967295 -k privileged
-a always,exit -F path=/bin/ping6 -F perm=x -F auid>=500 -F auid!=4294967295 -k privileged
-a always,exit -F path=/bin/umount -F perm=x -F auid>=500 -F auid!=4294967295 -k privileged
-a always,exit -F path=/usr/bin/umount -F perm=x -F auid>=500 -F auid!=4294967295 -k privileged
-a always,exit -F path=/bin/ping -F perm=x -F auid>=500 -F auid!=4294967295 -k privileged
-a always,exit -F path=/bin/cgexec -F perm=x -F auid>=500 -F auid!=4294967295 -k privileged
-a always,exit -F path=/usr/bin/cgexec -F perm=x -F auid>=500 -F auid!=4294967295 -k privileged
-a always,exit -F path=/lib64/dbus-1/dbus-daemon-launch-helper -F perm=x -F auid>=500 -F auid!=4294967295 -k privileged
-a always,exit -F path=/usr/lib64/dbus-1/dbus-daemon-launch-helper -F perm=x -F auid>=500 -F auid!=4294967295 -k privileged
-a always,exit -F path=/usr/sbin/unix_chkpwd –F perm=x -F auid>=500 -F auid!=4294967295 -k privileged
-a always,exit -F path=/usr/sbin/netreport -F perm=x -F auid>=500 -F auid!=4294967295 -k privileged
-a always,exit -F path=/usr/sbin/netreport -F perm=x -F auid>=500 -F auid!=4294967295 -k privileged
-a always,exit -F path=/usr/sbin/pam_timestamp_check -F perm=x -F auid>=500 -F auid!=4294967295 -k privileged
-a always,exit -F path=/usr/sbin/mount.nfs -F perm=x -F auid>=500 -F auid!=4294967295 -k privileged
-a always,exit -F path=/usr/libexec/sssd/p11_child -F perm=x -F auid>=500 -F auid!=4294967295 -k privileged
-a always,exit -F path=/usr/libexec/sssd/krb5_child -F perm=x -F auid>=500 -F auid!=4294967295 -k privileged
-a always,exit -F path=/usr/libexec/sssd/ldap_child -F perm=x -F auid>=500 -F auid!=4294967295 -k privileged
-a always,exit -F path=/usr/libexec/sssd/selinux_child -F perm=x -F auid>=500 -F auid!=4294967295 -k privileged
-a always,exit -F path=/usr/libexec/sssd/proxy_child -F perm=x -F auid>=500 -F auid!=4294967295 -k privileged
-a always,exit -F path=/usr/bin/screen -F perm=x -F auid>=500 -F auid!=4294967295 -k privileged
# these will never hit due to the 'sbin' key, but since they won't impact performance they are added to pass DISA STIG:
-a always,exit -F path=/sbin/mount.nfs -F perm=x -F auid>=500 -F auid!=4294967295 -k privileged
-a always,exit -F path=/sbin/unix_chkpwd -F perm=x -F auid>=500 -F auid!=4294967295 -k privileged
-a always,exit -F path=/sbin/pam_timestamp_check -F perm=x -F auid>=500 -F auid!=4294967295 -k privileged
-a always,exit -F path=/sbin/netreport -F perm=x -F auid>=500 -F auid!=4294967295 -k privileged
